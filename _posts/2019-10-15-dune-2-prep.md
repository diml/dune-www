---
layout: blog
title: Preparing for Dune 2.0.0
author: dimenix
tags: [ocaml, dune, jbuilder]
picture: /assets/imgs/dune-2.0.0.png
discuss: https://discuss.ocaml.org/t/dune-2-0-0-coming-soon/4102
---

So far we have establish a pattern: Dune delivers a continuous stream
of updates via monthly releases while major releases take a few
months. Among other things, we have been preparing Dune 2.0.0 for the
past few months and we plan to release it on the 28th of
October 2019. At this point, we are very eager to get Dune 2.0.0 out
of the door and resume our usual fast release cycle!

In this post, we'll recap the major changes in Dune 2.0.0 to help
users make the most of it.

As usual, this release will not break the build of any existing
released projects, except maybe for very few exceptions. New features
will appear in Dune 2.0.0. Those that affect the language inside
`dune` files will be unlocked by changing the first line of your
`dune-project` file to `(lang dune 2.0.0)`. Taking this action might
also require you to change a couple of things in your `dune`
files. Indeed, we took the opportunity of this new major release to
re-think and improve a few aspects of the language.

Making `dune` a pure binary
---------------------------

We wanted to make the `dune` package be a pure tool that one can
install once and for all instead of a tool tied to one particular
compiler. This is already the case for the `dune` binary itself; one
can build a `dune` binary with a given version of OCaml, drop it
anywhere and it will just work. `dune` is able to recognise its
environment and adapt to it at runtime. In particular, it is fully
relocatable and doesn't hardcode any path, except if you really ask
for it via the optional `./configure` step.

However, up to now we have been distributing the `dune.configurator`
library alongside `dune`, and this library tied the `dune` package to
the version of the compiler it was built against.

To move forward, we extracted the `dune.configurator` library into a
separate `dune-configurator` package. The old `dune.configurator` name
still exist for backward compatibility, however one must now add a
dependency on `dune-configurator` in their package description. We
already made this change in advance in the opam repository to ensure a
smooth 2.0.0 rleease.

Shared artefacts cache
----------------------

Some of you have already noticed, but in the master of dune there is
support for a shared artefacts cache. What is that exactly? All build
systems shares built artefacts between runs. This is what gives us
incremental compilation: we don't rebuild things that haven't changed
because we share the results with the previous run.

A global shared cache increasing sharing not only from one built to
another in the same workspace, but between workspaces as well. If you
are a user of opam local switches, this should eventually greatly
improve your workflow and in particular setting up a new local switch
will become much faster

In the future, we also plan to make this shared cache distribued,
which means that your CI will be able to deliver you pre-built
artefacts to speed up things even more.

This work is conducted by Tarides.

Better sandboxing
-----------------



Porting projects to Dune made easier
------------------------------------

Dune forces library names to start with the name of the package they
are part of. Among other things, this reduces the number of names
developers have to deal with and overall makes the system simpler.
However, historically OCaml projects have not all followed this
convention. As a result, it can sometimes be difficult to port
projects to Dune.

Fortunately Dune 2.0.0 provides a new feature to make this easier. It
is now possible to declare a deprecated name for a library that
doesn't follow Dune's convention of aligning package and library
names. For instance, historically the `menhir` package has been
installing a toplevel `menhirLib` library. In the Dune port,
`menhirLib` has been renamed `menhir.lib` and a pointer has been added
from the old name via:

```scheme
(deprecated_library_name
 (old_public_name menhirLib)
 (new_public_name menhir.lib))
```

Dune then arranges things so that the old name redirects to the new
one, for both Dune and non-Dune users.

